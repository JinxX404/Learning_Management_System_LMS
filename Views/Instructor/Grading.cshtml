@using Learning_Management_System.Models
@{
    ViewData["Title"] = "Student Grades";
    Layout = "_Layout";
    var grades = ViewBag.Grades as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var courses = ViewBag.InstructorCourses as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var selectedCourseId = ViewBag.SelectedCourseId as int?;
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/grades.css">
}

@await Html.PartialAsync("_InstructorNav")

<main class="container-xl my-4 my-md-5">
    <div class="mb-5">
        <h1 class="page-title display-4 fw-bold">Student Grades</h1>
        <p class="subtitle text-secondary fs-5">An overview of student academic performance across all courses.</p>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4 border-0 shadow-sm rounded-4">
        <div class="card-body p-4">
            <form method="get" asp-action="Grading" class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label for="courseFilter" class="form-label fw-semibold text-secondary">
                        <i class="bi bi-funnel me-2"></i>Filter by Course
                    </label>
                    <select id="courseFilter" name="courseId" class="form-select form-select-lg" onchange="this.form.submit()">
                        <option value="">-- All Courses --</option>
                        @foreach (var course in courses)
                        {
                            if (selectedCourseId == course.CourseId)
                            {
                                <option value="@course.CourseId" selected>@course.Title</option>
                            }
                            else
                            {
                                <option value="@course.CourseId">@course.Title</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    @if (selectedCourseId.HasValue)
                    {
                        <a href="@Url.Action("Grading")" class="btn btn-outline-secondary btn-lg w-100">
                            <i class="bi bi-x-circle me-2"></i>Clear Filter
                        </a>
                    }
                    else
                    {
                        <button type="button" class="btn btn-outline-secondary btn-lg w-100" disabled>
                            <i class="bi bi-funnel me-2"></i>No Filter Applied
                        </button>
                    }
                </div>
            </form>
        </div>
    </div>

    <div class="grades-card card bg-body-tertiary border-secondary-subtle shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-transparent px-4 pt-3">
            <h2 class="section-title fs-4 fw-semibold">
                Course Grades
                @if (selectedCourseId.HasValue)
                {
                    var selectedCourse = courses.FirstOrDefault(c => c.CourseId == selectedCourseId.Value);
                    if (selectedCourse != null)
                    {
                        <span class="badge bg-primary ms-2">@selectedCourse.Title</span>
                    }
                }
                else
                {
                    <span class="badge bg-secondary ms-2">All Courses</span>
                }
            </h2>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-borderless mb-0">
                    <thead class="table-light">
                        <tr class="text-secondary text-uppercase small">
                            <th class="px-4 py-3">Student</th>
                            <th class="px-4 py-3">Course</th>
                            <th class="px-4 py-3 text-center">Type</th>
                            <th class="px-4 py-3 text-center">Score</th>
                            <th class="px-4 py-3 text-end">Percentage</th>
                            <th class="px-4 py-3 text-center">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!grades.Any())
                        {
                            <tr>
                                <td class="px-4 py-5 text-center text-secondary" colspan="6">
                                    <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                                    @if (selectedCourseId.HasValue)
                                    {
                                        <p class="mb-0">No grades recorded for this course yet.</p>
                                    }
                                    else
                                    {
                                        <p class="mb-0">No grades recorded yet.</p>
                                    }
                                </td>
                            </tr>
                        }
                        else
                        {
                            foreach (var grade in grades)
                            {
                                var percentage = grade.MaxPoints > 0 ? (grade.Points / grade.MaxPoints) * 100 : 0;
                                <tr>
                                    <td class="px-4">@grade.FirstName @grade.LastName</td>
                                    <td class="px-4">@grade.CourseTitle</td>
                                    <td class="px-4 text-center text-secondary">@grade.GradableItemType</td>
                                    <td class="px-4 text-center">@grade.Points / @grade.MaxPoints</td>
                                    <td class="px-4 text-end fw-semibold">@Math.Round(percentage, 1)%</td>
                                    <td class="px-4 text-center text-secondary">@grade.GradedAt.ToString("MMM dd, yyyy")</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        @if (grades.Any())
        {
            <div class="card-footer bg-transparent border-top px-4 py-3">
                <div class="row text-center">
                    <div class="col-md-4">
                        <small class="text-secondary d-block">Total Grades</small>
                        <strong class="fs-5">@grades.Count()</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-secondary d-block">Average Score</small>
                        <strong class="fs-5">@Math.Round(grades.Average(g => (decimal)(g.Percentage ?? 0)), 1)%</strong>
                    </div>
                    <div class="col-md-4">
                        <small class="text-secondary d-block">Unique Students</small>
                        <strong class="fs-5">@grades.Select(g => g.UserId).Distinct().Count()</strong>
                    </div>
                </div>
            </div>
        }
    </div>
</main>