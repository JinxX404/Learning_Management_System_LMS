@using Learning_Management_System.Models
@{
    ViewData["Title"] = "Instructor - Announcements";
    Layout = "_Layout";
    var courses = ViewBag.Courses as IEnumerable<Course> ?? Enumerable.Empty<Course>();
    var recentNotifications = ViewBag.RecentNotifications as IEnumerable<Notification> ?? Enumerable.Empty<Notification>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/announcements.css">
}

@await Html.PartialAsync("_InstructorNav")

<div class="container-fluid py-4">
  <main class="main-content flex-grow-1 p-4 p-md-5">
    <div class="container-fluid" style="max-width: 896px;">
      <header class="d-flex justify-content-between align-items-center mb-5">
        <div>
          <h1 class="page-title fs-2 fw-bold">Announcements</h1>
          <p class="page-subtitle text-secondary">Send announcements to your students.</p>
        </div>
      </header>

      <div class="search-container d-flex justify-content-between align-items-center mb-5">
        <div class="input-group" style="max-width: 420px;">
          <span class="input-group-text bg-transparent border-end-0">
            <i class="fas fa-search text-secondary"></i>
          </span>
          <input type="text" id="searchInput" class="form-control search-input border-start-0" placeholder="Search announcements...">
        </div>
        <button class="btn btn-primary new-announcement-btn fw-semibold" data-bs-toggle="modal" data-bs-target="#newAnnouncementModal">
          <i class="fas fa-plus me-2"></i> New Announcement
        </button>
      </div>

      <!-- Success/Error Messages -->
      <div id="messageContainer"></div>

      <div class="d-flex flex-column gap-5">
        @if (!courses.Any())
        {
          <section>
            <div class="announcement-card card bg-tertiary rounded-3">
              <div class="card-body p-4">
                <p class="card-text text-secondary small mb-0">You don't have any courses yet. Create a course to start sending announcements.</p>
              </div>
            </div>
          </section>
        }
        else
        {
          <section id="courses">
            <h2 class="section-title fs-5 fw-bold mb-3">Your Courses (@courses.Count())</h2>
            <div class="d-flex flex-column gap-3">
              @foreach (var course in courses)
              {
                var enrollmentCount = course.CourseEnrollments?.Count ?? 0;
                <div class="announcement-card card bg-tertiary rounded-3">
                  <div class="card-body p-4">
                    <div class="d-flex align-items-start justify-content-between">
                      <div class="flex-grow-1">
                        <h5 class="card-title mb-2 fs-6 fw-semibold">@course.Title</h5>
                        <p class="card-text text-secondary small mb-2">@course.CourseCode</p>
                        <small class="text-secondary opacity-75" style="font-size: 0.75rem;">
                          <i class="fas fa-users me-1"></i> @enrollmentCount student(s) enrolled
                        </small>
                      </div>
                      <button class="btn btn-primary btn-sm" onclick="openAnnouncementModal(@course.CourseId, '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(course.Title))')">
                        <i class="fas fa-bullhorn me-1"></i> Send Announcement
                      </button>
                    </div>
                  </div>
                </div>
              }
            </div>
          </section>

          @if (recentNotifications.Any())
          {
            <section id="recent">
              <h2 class="section-title fs-5 fw-bold mb-3">Recent Announcements Sent (@recentNotifications.Count())</h2>
              <div class="d-flex flex-column gap-3">
                @foreach (var notification in recentNotifications.Take(10))
                {
                  <div class="announcement-card card bg-tertiary rounded-3">
                    <div class="card-body p-4">
                      <div class="d-flex align-items-start">
                        <div class="flex-grow-1">
                          <div class="d-flex align-items-center gap-3 mb-2">
                            <span class="badge badge-events rounded-pill">Sent</span>
                            <h5 class="card-title mb-0 fs-6 fw-semibold">@notification.Message</h5>
                          </div>
                          <small class="text-secondary opacity-75" style="font-size: 0.75rem;">
                            @notification.CreatedAt.ToString("MMMM d, yyyy h:mm tt")
                          </small>
                        </div>
                        <small class="text-secondary ms-4 flex-shrink-0">@GetTimeAgo(notification.CreatedAt)</small>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </section>
          }
          else
          {
            <section id="recent">
              <h2 class="section-title fs-5 fw-bold mb-3">Recent Announcements Sent</h2>
              <div class="announcement-card card bg-tertiary rounded-3">
                <div class="card-body p-4">
                  <p class="card-text text-secondary small mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    No announcements sent yet. Use the button above to send your first announcement!
                  </p>
                </div>
              </div>
            </section>
          }
        }
      </div>
    </div>
  </main>
</div>

<!-- Modal for New Announcement -->
<div class="modal fade" id="newAnnouncementModal" tabindex="-1" aria-labelledby="newAnnouncementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newAnnouncementModalLabel">New Announcement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="announcementForm">
          @Html.AntiForgeryToken()
          <div class="mb-3">
            <label for="courseSelect" class="form-label">Select Course</label>
            <select class="form-select" id="courseSelect" required>
              <option value="">Choose a course...</option>
              @foreach (var course in courses)
              {
                var enrollmentCount = course.CourseEnrollments?.Count ?? 0;
                <option value="@course.CourseId">@course.Title (@course.CourseCode) - @enrollmentCount student(s)</option>
              }
            </select>
          </div>
          <div class="mb-3">
            <label for="messageText" class="form-label">Message</label>
            <textarea class="form-control" id="messageText" rows="5" placeholder="Enter your announcement message..." required></textarea>
            <div class="form-text">This message will be sent to all students enrolled in the selected course.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="sendBtn" onclick="sendAnnouncement()">
          <i class="fas fa-paper-plane me-1"></i> Send Announcement
        </button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script>
function openAnnouncementModal(courseId, courseTitle) {
    // Remove quotes if they exist
    courseTitle = courseTitle.replace(/^"|"$/g, '');
    
    document.getElementById('courseSelect').value = courseId;
    document.getElementById('messageText').value = '';
    
    var modal = new bootstrap.Modal(document.getElementById('newAnnouncementModal'));
    modal.show();
}

function sendAnnouncement() {
    const courseId = document.getElementById('courseSelect').value;
    const message = document.getElementById('messageText').value.trim();
    
    if (!courseId || !message) {
        showMessage('Please select a course and enter a message', 'danger');
        return;
    }

    // Get selected course info
    const selectElement = document.getElementById('courseSelect');
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const courseInfo = selectedOption.text;
    
    // Extract student count from course info
    const studentMatch = courseInfo.match(/(\d+)\s+student/);
    const studentCount = studentMatch ? parseInt(studentMatch[1]) : 0;

    console.log('Sending announcement...');
    console.log('Course ID:', courseId);
    console.log('Message:', message);
    console.log('Student Count:', studentCount);

    // Disable button to prevent double-click
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Sending...';

    // Get anti-forgery token
    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

    fetch('@Url.Action("SendAnnouncement", "Instructor")', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'RequestVerificationToken': token
        },
        body: `courseId=${courseId}&message=${encodeURIComponent(message)}`
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.success) {
            let messageType = 'success';
            let messageIcon = '✓';
            
            // Change message style if no students
            if (!data.hasStudents || data.count === 0) {
                messageType = 'warning';
                messageIcon = '⚠️';
            }
            
            let detailMessage = data.message;
            if (data.savedRecords !== undefined) {
                detailMessage += ` (${data.savedRecords} record(s) saved to database)`;
            }
            
            showMessage(`${messageIcon} ${detailMessage}`, messageType);
            document.getElementById('messageText').value = '';
            var modal = bootstrap.Modal.getInstance(document.getElementById('newAnnouncementModal'));
            modal.hide();
            
            // Reload page after 2 seconds to show the new announcement
            setTimeout(() => location.reload(), 2000);
        } else {
            let errorMsg = `✗ ${data.message || 'Failed to send announcement'}`;
            if (data.details) {
                errorMsg += `<br><small>${data.details}</small>`;
            }
            showMessage(errorMsg, 'danger');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        showMessage('✗ An error occurred. Please try again. Check console for details.', 'danger');
    })
    .finally(() => {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i> Send Announcement';
    });
}

function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    container.innerHTML = '';
    container.appendChild(alert);
    
    // Scroll to message
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Auto-dismiss after 10 seconds
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 10000);
}

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded');
    
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.announcement-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }
});
</script>
}

@functions {
    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;
        
        if (timeSpan.TotalMinutes < 1) return "Just now";
        if (timeSpan.TotalMinutes < 60) return $"{(int)timeSpan.TotalMinutes} minute(s) ago";
        if (timeSpan.TotalHours < 24) return $"{(int)timeSpan.TotalHours} hour(s) ago";
        if (timeSpan.TotalDays < 7) return $"{(int)timeSpan.TotalDays} day(s) ago";
        if (timeSpan.TotalDays < 30) return $"{(int)(timeSpan.TotalDays / 7)} week(s) ago";
        
        return dateTime.ToString("MMM d, yyyy");
    }
}