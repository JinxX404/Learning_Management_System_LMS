@using Learning_Management_System.Models
@{
    ViewData["Title"] = "Student Dashboard";
    Layout = "_Layout";
    var enrollments = ViewBag.Enrollments as IEnumerable<CourseEnrollment> ?? Enumerable.Empty<CourseEnrollment>();
    var notifications = ViewBag.RecentNotifications as IEnumerable<Notification> ?? Enumerable.Empty<Notification>();
    int enrollmentCount = ViewBag.EnrollmentCount ?? 0;
    int assignmentCount = ViewBag.AssignmentCount ?? 0;
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/dashboard.css">
}
@await Html.PartialAsync("_StudentNav")


<div class="p-4 p-md-5">
    <section>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title font-display fs-5 fw-semibold text-body-emphasis mb-0">Enrolled Courses</h2>
            <span class="text-secondary small">Total: @enrollmentCount</span>
        </div>
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4 mt-2">
            @if (!enrollments.Any())
            {
                <div class="col">
                    <div class="card bg-tertiary border-custom shadow-sm rounded-4 h-100 overflow-hidden">
                        <div class="card-body">
                            <p class="card-text text-secondary small mb-0">No enrolled courses to display.</p>
                        </div>
                    </div>
                </div>
            }
            else
            {
                foreach (var enrollment in enrollments)
                {
                    <div class="col course-item">
                        <div class="card bg-tertiary border-custom shadow-sm rounded-4 h-100 overflow-hidden">
                            <div class="card-body">
                                <h5 class="card-title fw-semibold">@enrollment.Course?.Title</h5>
                                <p class="card-text text-secondary small">
                                    @if (enrollment.Course?.Instructor != null)
                                    {
                                        @($"{enrollment.Course.Instructor.FirstName} {enrollment.Course.Instructor.LastName}")
                                    }
                                    else
                                    {
                                        @:Instructor unavailable
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </section>

    <div class="row g-4 mt-4">
       

        <div class="col-12 col-lg-5 d-flex flex-column gap-4">
             <section>
                <h2 class="section-title font-display fs-5 fw-semibold text-body-emphasis mb-4">Upcoming Deadlines</h2>
                <div id="deadlines-container" class="d-flex flex-column gap-3">
                    <div class="card bg-tertiary shadow-sm border-0 p-3">
                        <p class="text-secondary mb-0">Loading deadlines...</p>
                    </div>
                </div>
            </section>

            <section>
                <h2 class="section-title font-display fs-5 fw-semibold text-body-emphasis mb-4">Notifications <span id="notif-badge" class="badge bg-danger rounded-pill d-none">0</span></h2>
                <div class="d-flex flex-column gap-3">
                    @if (!notifications.Any())
                    {
                        <div class="card bg-tertiary shadow-sm border-0 p-3">
                            <p class="text-secondary mb-0">No notifications yet.</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var notification in notifications)
                        {
                            <div class="card bg-tertiary shadow-sm border-0 p-3">
                                <div class="d-flex align-items-start gap-3">
                                    <div class="d-flex align-items-center justify-content-center rounded-circle flex-shrink-0" style="width:40px; height:40px; background-color: rgba(var(--bs-primary-rgb), 0.1); color: var(--bs-primary);">
                                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
                                            <path d="M15.2 3.8a2 2 0 0 1 2.8 2.8L12.5 12 8 7.5l7.2-3.7z"></path>
                                            <path d="m4.2 10.5 4.6 2.5 2.5 4.6 2.1 3.4-3.4-2.1-4.6-2.5-3.6-6.4Z"></path>
                                            <path d="m11.4 2.8 3.4 2.1 2.5 4.6 6.4 3.6-2.5 4.6-2.1 3.4-7.2-3.7L11.4 2.8z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="fw-medium text-body-emphasis small m-0">@notification.Message</p>
                                        <p class="text-secondary small m-0">@notification.CreatedAt.ToString("MMM d, yyyy h:mm tt")</p>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </section>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 1. Fetch Grade Trends Chart
        fetch('/Student/GetGradeTrends')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('gradeChart').getContext('2d');
                
                if (!data.labels || data.labels.length === 0) {
                    // Show "No Data" message
                    const container = document.getElementById('gradeChart').parentElement;
                    container.innerHTML = '<p class="text-secondary text-center my-5">No grade data available yet.</p>';
                    return;
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Grade (%)',
                            data: data.data,
                            borderColor: '#4f46e5', // Primary color
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            })
            .catch(err => {
                console.error('Error loading chart:', err);
                const container = document.getElementById('gradeChart').parentElement;
                container.innerHTML = '<p class="text-danger text-center my-5">Error loading performance data.</p>';
            });

        // 2. Poll for Dashboard Updates (Deadlines & Notifications)
        function updateDashboard() {
            fetch('/Student/GetDashboardUpdates')
                .then(response => response.json())
                .then(data => {
                    // Update Notification Badge
                    const badge = document.getElementById('notif-badge');
                    if (data.unreadCount > 0) {
                        badge.textContent = data.unreadCount;
                        badge.classList.remove('d-none');
                    } else {
                        badge.classList.add('d-none');
                    }

                    // Update Deadlines
                    const container = document.getElementById('deadlines-container');
                    container.innerHTML = ''; // Clear loading/old

                    if (data.upcomingDeadlines.length === 0) {
                        container.innerHTML = `
                            <div class="card bg-tertiary shadow-sm border-0 p-3">
                                <p class="text-secondary mb-0">No upcoming deadlines in the next 48 hours.</p>
                            </div>`;
                    } else {
                        data.upcomingDeadlines.forEach(item => {
                            const minutes = item.dueInMinutes;
                            let timeText = minutes > 60 ? `${Math.floor(minutes/60)}h ${minutes%60}m` : `${minutes}m`;
                            
                            const html = `
                                <div class="card bg-tertiary shadow-sm border-0 p-3 border-start border-4 border-warning">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="fw-medium text-body-emphasis small m-0">${item.title}</p>
                                            <p class="text-secondary x-small m-0">${item.courseName}</p>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-warning text-dark">Due in ${timeText}</span>
                                        </div>
                                    </div>
                                </div>`;
                            container.innerHTML += html;
                        });
                    }
                });
        }

        // Initial call and interval
        updateDashboard();
        setInterval(updateDashboard, 60000); // Poll every 60s
    });
</script>