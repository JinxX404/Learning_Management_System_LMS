@using Learning_Management_System.Helpers
@using Learning_Management_System.Models
@{
    ViewData["Title"] = $"Course Details | {ViewBag.Course?.Title}";
    Layout = "_Layout";
    var course = ViewBag.Course as Course;
    if (course == null)
    {
        <div class="container py-5">
            <div class="alert alert-warning">Course not found.</div>
        </div>
        return;
    }

    var instructorName = course.Instructor != null ? $"{course.Instructor.FirstName} {course.Instructor.LastName}" : "Instructor unavailable";
    var courseId = course.CourseId;

    // Check if student is enrolled
    var userId = SessionHelper.GetUserId(Context.Session);
    var isEnrolled = ViewBag.IsEnrolled as bool? ?? false;
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/course-details.css">
}

@await Html.PartialAsync("_StudentNav")

<main class="container-lg my-4 my-md-5">
    <div class="mx-auto" style="max-width: 56rem;">
        <div class="course-header position-relative rounded-4 overflow-hidden shadow-sm mb-4">
            <div class="position-absolute top-0 start-0 w-100 h-100 bg-gradient" style="--bs-gradient: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0.1));"></div>
            <div class="position-relative text-white p-4 p-md-5 d-flex flex-column justify-content-end hero-bg-image">
                <h1 class="course-title display-5 fw-bold">@course.Title</h1>
                <p class="course-instructor fs-5 mt-1" style="color: rgba(255,255,255,0.9)">with @instructorName</p>
            </div>
        </div>

        <div class="rounded-4 shadow-sm">
            <div class="border-bottom">
                <div class="d-flex align-items-center px-3">
                    <ul class="nav nav-tabs border-0">
                        <li class="nav-item">
                            <a class="nav-link active fw-semibold" asp-controller="Student" asp-action="CourseDetails" asp-route-id="@courseId">Overview</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-semibold" asp-controller="Student" asp-action="CourseContent" asp-route-id="@courseId">Content</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-semibold" asp-controller="Student" asp-action="Assignments" asp-route-courseId="@courseId">Assignments</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-semibold" asp-controller="Student" asp-action="CourseQuizzes" asp-route-id="@courseId">Quizzes</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="p-4 p-md-5">
                <section class="course-section mb-5">
                    <h2 class="section-title fs-2 fw-bold mb-3">Course Description</h2>
                    <p class="course-desc text-secondary">
                        @(!string.IsNullOrWhiteSpace(course.Description)
                                                ? course.Description
                                                : "No description has been provided for this course yet.")
                    </p>
                </section>

                <section class="course-section mb-5">
                    <h2 class="section-title fs-2 fw-bold mb-3">Instructor</h2>
                    <div class="d-flex align-items-center p-3 rounded-3 bg-body-tertiary">
                        <!-- Instructor Avatar -->
                        <div class="instructor-avatar-img rounded-circle me-3 flex-shrink-0" style="width: 50px; height: 50px; background-color: #ddd; display: flex; align-items: center; justify-content: center;">
                            <span class="material-symbols-outlined" style="font-size: 24px;">person</span>
                        </div>
                        <div>
                            <p class="fw-semibold text-body-emphasis mb-1">@instructorName</p>
                            <p class="text-secondary small mb-0">
                                @if (course.Instructor != null)
                                {
                                    @(course.Instructor?.InstructorProfile?.Department)
                                }
                                else
                                {
                                    @:Department unavailable
                                }
                            </p>
                        </div>
                    </div>
                </section>

                <section class="course-section">
                    <h2 class="section-title fs-2 fw-bold mb-3">Course Details</h2>
                    <dl class="row g-3">
                        <div class="col-md-6">
                            <dt class="small text-secondary">Course Code</dt>
                            <dd class="fw-medium text-body-emphasis">@course.CourseCode</dd>
                        </div>
                        <div class="col-md-6">
                            <dt class="small text-secondary">Credits</dt>
                            <dd class="fw-medium text-body-emphasis">@course.CreditHours</dd>
                        </div>
                        <div class="col-md-6">
                            <dt class="small text-secondary">Term</dt>
                            <dd class="fw-medium text-body-emphasis">@course.AcademicTerm?.TermName</dd>
                        </div>
                        <div class="col-md-6">
                            <dt class="small text-secondary">Status</dt>
                            <dd class="fw-medium text-body-emphasis">@course.Status</dd>
                        </div>
                        <div class="col-12">
                            <dt class="small text-secondary">Instructor</dt>
                            <dd class="fw-medium text-body-emphasis">@instructorName</dd>
                        </div>
                    </dl>
                </section>

                <!-- Enroll Button if not enrolled -->
                @if (!isEnrolled)
                {
                    <div class="mt-4">
                        <form asp-action="EnrollInCourse" asp-controller="Student" method="post">
                            <input type="hidden" name="courseId" value="@courseId" />
                            <button type="submit" class="btn btn-primary fw-semibold">Enroll in this Course</button>
                        </form>
                    </div>
                }
            </div>
        </div>
    </div>
</main>